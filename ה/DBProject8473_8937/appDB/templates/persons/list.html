{% extends "base.html" %} {% block content %}
<div class="table-container">
  <h2>ğŸ‘¥ ×¨×©×™××ª ×× ×©×™×</h2>
  {% if success %}
  <div class="toast-wrapper">
    <div class="toast-message" id="toast-message">
      <button class="close-btn" onclick="closeToast()">Ã—</button>
      {{ success }}
    </div>
  </div>
  <script>
    function closeToast() {
      const toast = document.getElementById("toast-message");
      toast.style.opacity = "0";
      setTimeout(() => (toast.style.display = "none"), 300);
    }
    setTimeout(() => closeToast(), 5000); // × ×¢×œ× ××—×¨×™ 5 ×©× ×™×•×ª
  </script>
  {% endif %}

  <a href="/persons/new" class="btn-primary">â• ×”×•×¡×£ ××“×</a>
  <table>
    <thead>
      <tr>
        <th>×©× ××œ×</th>
        <th>××™××™×™×œ</th>
        <th>×˜×œ×¤×•×Ÿ</th>
        <th>×¤×¢×•×œ×•×ª</th>
        <th>×¤×¨×•×¦×“×•×¨×•×ª</th>
      </tr>
    </thead>
    <tbody>
      {% for person in persons %}
      <tr>
        <td>{{ person.fullname }}</td>
        <td>{{ person.email }}</td>
        <td>{{ person.phonenumber }}</td>
        <td>
          <a href="/persons/{{ person.id }}/edit" class="btn-secondary"
            >âœï¸ ×¢×¨×™×›×”</a
          >
          <form
            method="post"
            action="/persons/{{ person.id }}/delete"
            style="display: inline"
          >
            <button
              class="btn-danger"
              onclick="return confirm('×œ××—×•×§ ××ª {{ person.fullname }}?')"
            >
              ××—×™×§×”
            </button>
          </form>
        </td>
        <td>
          <form class="customer-action-form">
            <input type="hidden" name="customer_id" value="{{ person.id }}" />
            <select name="action">
              <option value="payments">×¡×š ×ª×©×œ×•××™×</option>
              <option value="available_trips">×˜×™×•×œ×™× ×–××™× ×™×</option>
            </select>
            <button type="submit" class="btn-info">×”×¦×’</button>
          </form>
          <div class="action-result" id="result-{{ person.id }}"></div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.querySelectorAll(".customer-action-form").forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const customer_id = formData.get("customer_id");

      const response = await fetch("/queries/customer-actions", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      const target = document.getElementById("result-" + customer_id);
      if (target) {
        target.innerHTML = `<div class="result-box" style="margin-top: 10px; border: 1px solid #aaa; padding: 10px; background: #f9f9f9">${data.html}</div>`;
      }
    });
  });
</script>
{% endblock %}
